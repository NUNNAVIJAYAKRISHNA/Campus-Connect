<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login page</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Login Container */
        .login-container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            width: 300px;
            max-width: 90%;
        }
        h1 {
            color: #333;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .input-container {
            position: relative;
            width: 100%;
            margin: 10px 0;
        }
        input {
            padding: 10px;
            width: calc(100% - 24px); /* Adjust for padding and border */
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            width: 100%;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            font-size: 15px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #218838;
        }

        /* Google Button Specifics */
        .google-btn {
            background-color: #ffffff;
            color: #444;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .google-btn:hover {
            background-color: #f7f7f7;
        }
        .google-btn svg {
            margin-right: 10px;
        }

        .divider {
            margin: 20px 0;
            font-weight: bold;
            color: #888;
        }

        /* Utility & Links */
        .extra-links {
            text-align: right;
            margin-top: 5px;
            font-size: 14px;
        }
        .extra-links a {
            color: #28a745;
            text-decoration: none;
        }
        .extra-links a:hover {
            text-decoration: underline;
        }
        #toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
            user-select: none; /* Prevent text selection */
        }
        .signup-link {
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<!-- Google Identity Services Library -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<body>
    <div class="login-container">
        <h1>Login</h1>
        <form id="login-form">
            <div class="input-container">
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            <div class="input-container">
                <input type="password" id="password" placeholder="Enter your password" required>
                <span id="toggle-password">üëÅÔ∏è</span>
            </div>
            <div class="extra-links">
                <a href="#">Forgot Password?</a>
            </div>
            <button type="submit">Login</button>
        </form>
       
    <!-- Google Sign-in button is rendered here by Google's script -->
   
    <div id="error-message" style="color: red; margin-top: 8px;"></div>
    </div>

    <script type="module">
        import { auth, db } from './assets/js/firebaseOptions.js';
        import {
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithCredential,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // Elements
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const togglePassword = document.querySelector('#toggle-password');
        const errorDiv = document.getElementById('error-message');

        // Utility to show errors
        function showError(message) {
            if (errorDiv) errorDiv.textContent = message;
            else alert(message);
        }

        // Toggle password visibility
        if (togglePassword) {
            togglePassword.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
            });
        }

        // Email/password sign-in
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorDiv.textContent = '';
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                showError('Please enter email and password.');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Fetch user document from Firestore (if exists)
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    const snap = await getDoc(userDocRef);
                    if (snap.exists()) {
                        console.log('User data from Firestore:', snap.data());
                        // Optionally save to localStorage/sessionStorage
                        sessionStorage.setItem('user', JSON.stringify(snap.data()));

                        // Role-based redirect
                        const role = snap.data().role;
                        if (role === 'admin') {
                            window.location.href = 'add_event_admin.html';
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Could not fetch user data:', err);
                }

                // Default redirect to regular user dashboard
                window.location.href = 'user_dashboard.html';
            } catch (error) {
                console.error('Login error', error);
                showError(error.message || 'Login failed.');
            }
        });

        // Redirect already authenticated users to appropriate dashboard based on role
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    const snap = await getDoc(userDocRef);
                    if (snap.exists()) {
                        const role = snap.data().role;
                        if (role === 'admin') {
                            window.location.href = 'add_event_admin.html';
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Error checking user role on auth state change:', err);
                }
                // Default
                window.location.href = 'user_dashboard.html';
            }
        });

        // Google Sign-In handling using Google's Identity Services
        window.onload = function () {
            if (window.google && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: '1017566795753-j63trcd2t0lpfvr99ntbgba16rl6sp0l.apps.googleusercontent.com',
                    callback: async (response) => {
                        try {
                            const credential = GoogleAuthProvider.credential(response.credential);
                            const userCredential = await signInWithCredential(auth, credential);
                            const user = userCredential.user;

                            // Add or update user record in Firestore (does not overwrite role)
                                await setDoc(doc(db, 'users', user.uid), {
                                    name: user.displayName || null,
                                    email: user.email,
                                    photoURL: user.photoURL || null,
                                    lastLogin: new Date()
                                }, { merge: true });

                                // Try to read role from Firestore (in case user was created with a role)
                                try {
                                    const userDocRef = doc(db, 'users', user.uid);
                                    const snap = await getDoc(userDocRef);
                                    if (snap.exists()) {
                                        const data = snap.data();
                                        sessionStorage.setItem('user', JSON.stringify(data));
                                        if (data.role === 'admin') {
                                            window.location.href = 'add_event_admin.html';
                                            return;
                                        }
                                    }
                                } catch (err) {
                                    console.warn('Could not fetch user data after Google sign-in:', err);
                                }

                                // Default redirect for Google sign-ins
                                sessionStorage.setItem('user', JSON.stringify({ uid: user.uid, email: user.email, name: user.displayName }));
                                window.location.href = 'user_dashboard.html';
                        } catch (err) {
                            console.error('Google sign-in error', err);
                            showError('Google sign-in failed.');
                        }
                    }
                });

                google.accounts.id.renderButton(
                    document.getElementById('google-signin-btn'),
                    { theme: 'outline', size: 'large', width: '300' }
                );
                google.accounts.id.prompt();
            } else {
                console.warn('Google Identity Services not loaded yet.');
            }
        };
    </script>
</body>
</html>